<div class="container-fluid mt-4">
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3"
  >
    <h2 class="mb-0">Employee Management</h2>
    <a routerLink="/admin/employees/add" class="btn btn-primary w-md-auto"> Add New Employee </a>
  </div>

  @if (isLoading) {
  <div class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  } @else {
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <input
            type="text"
            class="form-control"
            placeholder="Search by name, phone, or national ID..."
            [(ngModel)]="searchTerm"
            (input)="onSearchInput()"
            (keyup.enter)="onSearch()"
          />
        </div>
        <div class="col-12 col-md-3">
          <select class="form-select" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
            <option [value]="5">5 per page</option>
            <option [value]="10">10 per page</option>
            <option [value]="25">25 per page</option>
            <option [value]="50">50 per page</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="card position-relative">
    @if (isLoading && hasLoadedOnce) {
    <div
      class="position-absolute top-0 start-0 end-0 bottom-0 d-flex align-items-center justify-content-center rounded"
      style="background: rgba(255, 255, 255, 0.85); z-index: 5"
    >
      <div class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading results...</span>
        </div>
        <p class="mt-2 mb-0 text-muted">Loading results...</p>
      </div>
    </div>
    }
    <div class="card-body">
      <div class="table-responsive table-responsive-employees">
        <table class="table table-striped table-hover employee-table">
          <thead>
            <tr>
              <th (click)="sort('firstName')" style="cursor: pointer">
                Name {{ getSortIcon('firstName') }}
              </th>
              <th (click)="sort('phoneNumber')" style="cursor: pointer">
                Phone {{ getSortIcon('phoneNumber') }}
              </th>
              <th (click)="sort('nationalId')" style="cursor: pointer">
                National ID {{ getSortIcon('nationalId') }}
              </th>
              <th (click)="sort('age')" style="cursor: pointer">Age {{ getSortIcon('age') }}</th>
              <th>Signature</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @if (employees.length === 0) {
            <tr>
              <td colspan="6" class="text-center">No employees found</td>
            </tr>
            } @else { @for (employee of employees; track employee.id) {
            <tr>
              <td data-label="Name">{{ employee.firstName }} {{ employee.lastName }}</td>
              <td data-label="Phone">{{ employee.phoneNumber }}</td>
              <td data-label="National ID">
                {{ employee.nationalID ?? employee.nationalId }}
              </td>
              <td data-label="Age">{{ employee.age }}</td>
              <td data-label="Signature">
                @if (employee.electronicSignature) {
                <span class="badge bg-success">Yes</span>
                } @else {
                <span class="badge bg-warning">No</span>
                }
              </td>
              <td data-label="Actions">
                <div class="btn-group btn-group-sm">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="openHoursModal(employee)"
                    title="Hours worked (last week)"
                  >
                    Hours
                  </button>
                  <a
                    [routerLink]="['/admin/employees/edit', employee.id]"
                    class="btn btn-outline-primary"
                  >
                    Edit
                  </a>
                  <button
                    type="button"
                    class="btn btn-outline-danger"
                    (click)="
                      openDeleteModal(employee.id!, employee.firstName + ' ' + employee.lastName)
                    "
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>
            } }
          </tbody>
        </table>
      </div>

      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center align-items-center flex-wrap gap-2">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a
              class="page-link"
              href="#"
              (click)="$event.preventDefault(); currentPage > 1 && changePage(currentPage - 1)"
              [attr.aria-disabled]="currentPage === 1"
            >
              Back
            </a>
          </li>
          <li class="page-item disabled">
            <span class="page-link">Page {{ currentPage }}</span>
          </li>
          <li class="page-item" [class.disabled]="!isNextPage">
            <a
              class="page-link"
              href="#"
              (click)="$event.preventDefault(); isNextPage && changePage(currentPage + 1)"
              [attr.aria-disabled]="!isNextPage"
            >
              Next
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  }
</div>

@if (showHoursModal) {
<div
  class="modal show d-block"
  tabindex="-1"
  role="dialog"
  aria-labelledby="hoursModalLabel"
  aria-modal="true"
  style="background: rgba(0, 0, 0, 0.5)"
  (click)="closeHoursModal()"
>
  <div
    class="modal-dialog modal-dialog-centered"
    role="document"
    (click)="$event.stopPropagation()"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="hoursModalLabel">Hours Worked (Last Week)</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="closeHoursModal()"
          [disabled]="isLoadingHours"
        ></button>
      </div>
      <div class="modal-body">
        @if (hoursModalEmployee) {
        <p class="mb-2">
          <strong>{{ hoursModalEmployee.name }}</strong>
        </p>
        @if (isLoadingHours) {
        <div class="d-flex align-items-center gap-2">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span>Loading hours...</span>
        </div>
        } @else if (hoursLastWeek !== null) {
        <p class="mb-0">
          Total hours (last 7 days): <strong>{{ hoursLastWeek | number : '1.1-1' }} h</strong>
        </p>
        } @else {
        <p class="mb-0 text-muted">
          Total hours (last 7 days): â€” <span class="small">(API not connected yet)</span>
        </p>
        } }
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeHoursModal()"
          [disabled]="isLoadingHours"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>
} @if (showDeleteModal) {
<div
  class="modal show d-block"
  tabindex="-1"
  role="dialog"
  aria-labelledby="deleteModalLabel"
  aria-modal="true"
  style="background: rgba(0, 0, 0, 0.5)"
  (click)="closeDeleteModal()"
>
  <div
    class="modal-dialog modal-dialog-centered"
    role="document"
    (click)="$event.stopPropagation()"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Employee</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="closeDeleteModal()"
          [disabled]="isDeleting"
        ></button>
      </div>
      <div class="modal-body">
        @if (employeeToDelete) {
        <p class="mb-0">
          Are you sure you want to delete <strong>{{ employeeToDelete.name }}</strong
          >? This action cannot be undone.
        </p>
        }
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeDeleteModal()"
          [disabled]="isDeleting"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="confirmDelete()"
          [disabled]="isDeleting"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
</div>
}
